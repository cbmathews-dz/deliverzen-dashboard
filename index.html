<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deliverzen Operations Hub</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Plus Jakarta Sans', -apple-system, sans-serif; background: #E9F1FB; color: #0B1B3A; }
        .container { max-width: 1600px; margin: 0 auto; }
        
        /* Header */
        .header { background: #0B1B3A; padding: 0 32px; display: flex; align-items: center; justify-content: space-between; height: 60px; }
        .logo-section { display: flex; align-items: center; gap: 12px; }
        .logo { width: 30px; height: 30px; background: linear-gradient(135deg, #5A9CFE, #6DD5DB); border-radius: 6px; }
        .logo-text { font-size: 19px; font-weight: 800; color: #FFF; }
        .badge { font-size: 10px; background: rgba(43,108,244,0.2); color: #4A8AF7; padding: 3px 11px; border-radius: 20px; font-weight: 700; text-transform: uppercase; }
        .header-info { display: flex; align-items: center; gap: 20px; font-size: 12px; color: #8FA3C4; }
        
        /* Tabs */
        .tabs { background: #FFF; border-bottom: 1px solid #D4DEF0; padding: 0 32px; display: flex; }
        .tab { background: transparent; color: #8494AC; border: none; border-bottom: 2.5px solid transparent; padding: 13px 20px; font-size: 13px; font-weight: 700; cursor: pointer; transition: all 0.2s; }
        .tab:hover { color: #2B6CF4; }
        .tab.active { color: #2B6CF4; border-bottom-color: #2B6CF4; }
        
        /* Filters */
        .filters { padding: 14px 32px; display: flex; gap: 14px; align-items: flex-end; flex-wrap: wrap; background: #FFF; border-bottom: 1px solid #E4ECF7; }
        .filter-group { display: flex; flex-direction: column; gap: 4px; }
        .filter-group label { font-size: 10px; color: #8494AC; text-transform: uppercase; font-weight: 700; }
        .filter-group select, .filter-group input { background: #FFF; color: #0B1B3A; border: 1.5px solid #D4DEF0; border-radius: 10px; padding: 8px 12px; font-size: 13px; font-weight: 600; outline: none; font-family: 'Plus Jakarta Sans', sans-serif; }
        .filter-group select { appearance: none; background-image: url("data:image/svg+xml,%3Csvg width='10' height='6' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L5 5L9 1' stroke='%234A5B78' stroke-width='1.5'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; padding-right: 34px; }
        .btn-apply { background: #2B6CF4; color: #FFF; border: none; border-radius: 10px; padding: 9px 24px; font-size: 13px; font-weight: 700; cursor: pointer; margin-top: 18px; }
        .btn-apply:hover { background: #1E5ADB; }
        
        /* Content */
        .content { padding: 32px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* KPI Grid */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .kpi-card { background: #FFF; border-radius: 16px; padding: 20px; border: 1px solid #E4ECF7; position: relative; overflow: hidden; }
        .kpi-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: var(--color, #2B6CF4); }
        .kpi-label { font-size: 11px; color: #8494AC; font-weight: 700; text-transform: uppercase; margin-bottom: 8px; }
        .kpi-value { font-size: 32px; font-weight: 800; color: #0B1B3A; margin-bottom: 8px; }
        .kpi-badge { display: inline-flex; align-items: center; gap: 6px; padding: 3px 11px; border-radius: 20px; font-size: 11px; font-weight: 700; }
        
        /* Table */
        .table-container { background: #FFF; border-radius: 16px; padding: 24px; border: 1px solid #E4ECF7; overflow-x: auto; }
        .table-header { font-size: 16px; font-weight: 700; margin-bottom: 16px; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 12px 16px; font-size: 11px; color: #8494AC; font-weight: 700; text-transform: uppercase; border-bottom: 2px solid #E4ECF7; }
        td { padding: 14px 16px; font-size: 13px; border-bottom: 1px solid #F5F8FD; }
        tr:hover { background: #F5F8FD; }
        .status-badge { display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 700; }
        .status-passed { background: #E6F7EF; color: #0EA55B; }
        .status-failed { background: #FDE8E8; color: #DC2C2C; }
        
        /* Loading */
        .loading { text-align: center; padding: 40px; color: #8494AC; }
        .spinner { border: 3px solid #E4ECF7; border-top: 3px solid #2B6CF4; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 16px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="logo-section">
            <div class="logo"></div>
            <span class="logo-text">Deliverzen</span>
            <span class="badge">Operations Hub</span>
        </div>
        <div class="header-info">
            <span>445 S Royal Ln, Coppell TX</span>
            <span>|</span>
            <span id="currentDate"></span>
        </div>
    </div>
    
    <!-- Tabs -->
    <div class="tabs">
        <button class="tab active" onclick="switchTab('overview')">ðŸ“Š Overview</button>
        <button class="tab" onclick="switchTab('breakdown')">ðŸ“¦ Outbound Breakdown</button>
    </div>
    
    <!-- Filters -->
    <div class="filters">
        <div class="filter-group">
            <label>Customer</label>
            <select id="customerFilter">
                <option value="all">All Customers</option>
            </select>
        </div>
        <div class="filter-group">
            <label>Days Back</label>
            <select id="daysFilter">
                <option value="7">Last 7 Days</option>
                <option value="14">Last 14 Days</option>
                <option value="30" selected>Last 30 Days</option>
                <option value="60">Last 60 Days</option>
                <option value="90">Last 90 Days</option>
            </select>
        </div>
        
        <!-- Breakdown-specific filters -->
        <div class="filter-group" id="slaStatusFilter" style="display:none;">
            <label>SLA Status</label>
            <select id="slaStatus">
                <option value="all">All Orders</option>
                <option value="passed">Passed Only</option>
                <option value="failed">Failed Only</option>
            </select>
        </div>
        
        <button class="btn-apply" onclick="loadData()">Apply Filters</button>
    </div>
    
    <div class="container">
        <!-- OVERVIEW TAB -->
        <div id="tab-overview" class="tab-content active content">
            <div id="kpiSection" class="loading">
                <div class="spinner"></div>
                <div>Loading dashboard data...</div>
            </div>
        </div>
        
        <!-- OUTBOUND BREAKDOWN TAB -->
        <div id="tab-breakdown" class="tab-content content">
            <div class="table-container">
                <div class="table-header">Outbound Order Details</div>
                <div id="breakdownTable" class="loading">
                    <div class="spinner"></div>
                    <div>Loading order data...</div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const API_BASE = 'https://deliverzen-ops-backend.azurewebsites.net/api';
        let currentTab = 'overview';
        
        // Initialize
        document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        loadCustomers();
        loadData();
        
        // Auto-refresh every 15 minutes
        setInterval(loadData, 900000);
        
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector(`button[onclick="switchTab('${tab}')"]`).classList.add('active');
            document.getElementById(`tab-${tab}`).classList.add('active');
            
            // Show/hide breakdown-specific filters
            document.getElementById('slaStatusFilter').style.display = tab === 'breakdown' ? 'flex' : 'none';
            
            loadData();
        }
        
        async function loadCustomers() {
            try {
                const response = await fetch(`${API_BASE}/customers`);
                const data = await response.json();
                
                if (data.success) {
                    const select = document.getElementById('customerFilter');
                    select.innerHTML = '<option value="all">All Customers</option>';
                    data.data.forEach(c => {
                        const option = document.createElement('option');
                        option.value = c.ACCOUNT_ID;
                        option.textContent = c.CUSTOMER_NAME;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading customers:', error);
            }
        }
        
        async function loadData() {
            if (currentTab === 'overview') {
                loadOverview();
            } else if (currentTab === 'breakdown') {
                loadBreakdown();
            }
        }
        
        async function loadOverview() {
            const days = document.getElementById('daysFilter').value;
            const customer = document.getElementById('customerFilter').value;
            
            document.getElementById('kpiSection').innerHTML = '<div class="spinner"></div><div>Loading...</div>';
            
            try {
                const url = `${API_BASE}/executive-summary?days=${days}${customer !== 'all' ? '&customer_id=' + customer : ''}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (!data.success) throw new Error(data.error);
                
                const kpis = data.data;
                
                document.getElementById('kpiSection').innerHTML = `
                    <div class="kpi-grid">
                        ${createKPI('D2C OTF %', kpis.d2c_otf_pct?.toFixed(1) + '%', kpis.d2c_otf_pct >= 95 ? '#0EA55B' : kpis.d2c_otf_pct >= 90 ? '#D97B06' : '#DC2C2C')}
                        ${createKPI('B2B OTF %', kpis.b2b_otf_pct?.toFixed(1) + '%', kpis.b2b_otf_pct >= 92 ? '#0EA55B' : kpis.b2b_otf_pct >= 85 ? '#D97B06' : '#DC2C2C')}
                        ${createKPI('Total Orders', kpis.total_orders?.toLocaleString(), '#2B6CF4')}
                        ${createKPI('D2C Orders', kpis.d2c_orders?.toLocaleString(), '#7C3AED')}
                        ${createKPI('B2B Orders', kpis.b2b_orders?.toLocaleString(), '#0891B2')}
                        ${createKPI('On-Time Receipt %', kpis.on_time_receipt_pct?.toFixed(1) + '%', kpis.on_time_receipt_pct >= 95 ? '#0EA55B' : '#D97B06')}
                    </div>
                `;
            } catch (error) {
                document.getElementById('kpiSection').innerHTML = `
                    <div style="color: #DC2C2C; text-align: center; padding: 40px;">
                        <div style="font-weight: 700; margin-bottom: 8px;">Error Loading Data</div>
                        <div style="font-size: 13px;">${error.message}</div>
                    </div>
                `;
            }
        }
        
        async function loadBreakdown() {
            const days = document.getElementById('daysFilter').value;
            const customer = document.getElementById('customerFilter').value;
            const slaStatus = document.getElementById('slaStatus').value;
            
            document.getElementById('breakdownTable').innerHTML = '<div class="spinner"></div><div>Loading...</div>';
            
            try {
                const url = `${API_BASE}/outbound-breakdown?days=${days}${customer !== 'all' ? '&customer_id=' + customer : ''}&sla_status=${slaStatus}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (!data.success) throw new Error(data.error);
                
                const orders = data.data;
                
                if (orders.length === 0) {
                    document.getElementById('breakdownTable').innerHTML = '<div style="text-align:center; color:#8494AC; padding:40px;">No orders found with selected filters</div>';
                    return;
                }
                
                let html = `
                    <table>
                        <thead>
                            <tr>
                                <th>Order Number</th>
                                <th>Customer</th>
                                <th>Type</th>
                                <th>Order Date</th>
                                <th>Ship Date</th>
                                <th>Expected Ship</th>
                                <th>Cycle Time (hrs)</th>
                                <th>Status</th>
                                <th>SLA Result</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                orders.forEach(order => {
                    html += `
                        <tr>
                            <td style="font-family: 'JetBrains Mono', monospace; font-weight: 600;">${order.ORDER_NUMBER || 'N/A'}</td>
                            <td>${order.CUSTOMER_NAME || 'Unknown'}</td>
                            <td>${order.ORDER_TYPE}</td>
                            <td>${order.ORDER_DATE || 'N/A'}</td>
                            <td>${order.SHIP_DATE || '<span style="color:#8494AC;">Not Shipped</span>'}</td>
                            <td>${order.EXPECTED_SHIP_DATE || 'N/A'}</td>
                            <td>${order.CYCLE_TIME_HOURS !== null ? order.CYCLE_TIME_HOURS : '<span style="color:#8494AC;">â€”</span>'}</td>
                            <td><span style="font-size:11px; color:#8494AC;">${order.FULFILLMENT_STATUS || 'pending'}</span></td>
                            <td><span class="status-badge ${order.SLA_STATUS === 'PASSED' ? 'status-passed' : 'status-failed'}">${order.SLA_STATUS}</span></td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                    <div style="margin-top: 16px; font-size: 12px; color: #8494AC;">
                        Showing ${orders.length} orders
                    </div>
                `;
                
                document.getElementById('breakdownTable').innerHTML = html;
            } catch (error) {
                document.getElementById('breakdownTable').innerHTML = `
                    <div style="color: #DC2C2C; text-align: center; padding: 40px;">
                        <div style="font-weight: 700; margin-bottom: 8px;">Error Loading Breakdown</div>
                        <div style="font-size: 13px;">${error.message}</div>
                    </div>
                `;
            }
        }
        
        function createKPI(label, value, color) {
            return `
                <div class="kpi-card" style="--color: ${color}">
                    <div class="kpi-label">${label}</div>
                    <div class="kpi-value" style="color: ${color}">${value || 'N/A'}</div>
                </div>
            `;
        }
    </script>
</body>
</html>