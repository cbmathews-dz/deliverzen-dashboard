<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deliverzen Operations Hub</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Plus Jakarta Sans', -apple-system, sans-serif; background: #E9F1FB; color: #0B1B3A; }
        .container { max-width: 1600px; margin: 0 auto; }
        
        .header { background: #0B1B3A; padding: 0 32px; display: flex; align-items: center; justify-content: space-between; height: 60px; }
        .logo-section { display: flex; align-items: center; gap: 12px; }
        .logo { width: 30px; height: 30px; background: linear-gradient(135deg, #5A9CFE, #6DD5DB); border-radius: 6px; }
        .logo-text { font-size: 19px; font-weight: 800; color: #FFF; }
        .badge { font-size: 10px; background: rgba(43,108,244,0.2); color: #4A8AF7; padding: 3px 11px; border-radius: 20px; font-weight: 700; text-transform: uppercase; }
        .header-info { display: flex; align-items: center; gap: 20px; font-size: 12px; color: #8FA3C4; }
        
        .tabs { background: #FFF; border-bottom: 1px solid #D4DEF0; padding: 0 32px; display: flex; }
        .tab { background: transparent; color: #8494AC; border: none; border-bottom: 2.5px solid transparent; padding: 13px 20px; font-size: 13px; font-weight: 700; cursor: pointer; transition: all 0.2s; }
        .tab:hover { color: #2B6CF4; }
        .tab.active { color: #2B6CF4; border-bottom-color: #2B6CF4; }
        
        .filters { padding: 14px 32px; display: flex; gap: 14px; align-items: flex-end; flex-wrap: wrap; background: #FFF; border-bottom: 1px solid #E4ECF7; }
        .filter-group { display: flex; flex-direction: column; gap: 4px; }
        .filter-group label { font-size: 10px; color: #8494AC; text-transform: uppercase; font-weight: 700; }
        .filter-group select, .filter-group input { background: #FFF; color: #0B1B3A; border: 1.5px solid #D4DEF0; border-radius: 10px; padding: 8px 12px; font-size: 13px; font-weight: 600; outline: none; font-family: 'Plus Jakarta Sans', sans-serif; }
        .filter-group select { appearance: none; background-image: url("data:image/svg+xml,%3Csvg width='10' height='6' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L5 5L9 1' stroke='%234A5B78' stroke-width='1.5'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; padding-right: 34px; }
        .btn-apply { background: #2B6CF4; color: #FFF; border: none; border-radius: 10px; padding: 9px 24px; font-size: 13px; font-weight: 700; cursor: pointer; margin-top: 18px; }
        
        .content { padding: 32px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .kpi-card { background: #FFF; border-radius: 16px; padding: 20px; border: 1px solid #E4ECF7; position: relative; overflow: hidden; }
        .kpi-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: var(--color, #2B6CF4); }
        .kpi-label { font-size: 11px; color: #8494AC; font-weight: 700; text-transform: uppercase; margin-bottom: 8px; }
        .kpi-value { font-size: 32px; font-weight: 800; color: #0B1B3A; margin-bottom: 8px; }
        
        .chart-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .chart-card { background: #FFF; border-radius: 16px; padding: 24px; border: 1px solid #E4ECF7; }
        .chart-title { font-size: 14px; font-weight: 700; margin-bottom: 16px; }
        
        .table-container { background: #FFF; border-radius: 16px; padding: 24px; border: 1px solid #E4ECF7; overflow-x: auto; }
        .table-header { font-size: 16px; font-weight: 700; margin-bottom: 16px; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 12px 16px; font-size: 11px; color: #8494AC; font-weight: 700; text-transform: uppercase; border-bottom: 2px solid #E4ECF7; cursor: pointer; user-select: none; }
        th:hover { background: #F5F8FD; }
        th.sort-asc::after { content: ' â–²'; color: #2B6CF4; }
        th.sort-desc::after { content: ' â–¼'; color: #2B6CF4; }
        td { padding: 14px 16px; font-size: 13px; border-bottom: 1px solid #F5F8FD; }
        tr:hover { background: #F5F8FD; }
        .status-badge { display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 700; }
        .status-passed { background: #E6F7EF; color: #0EA55B; }
        .status-failed { background: #FDE8E8; color: #DC2C2C; }
        
        .loading { text-align: center; padding: 40px; color: #8494AC; }
        .spinner { border: 3px solid #E4ECF7; border-top: 3px solid #2B6CF4; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 16px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo-section">
            <div class="logo"></div>
            <span class="logo-text">Deliverzen</span>
            <span class="badge">Operations Hub</span>
        </div>
        <div class="header-info">
            <span>445 S Royal Ln, Coppell TX</span>
            <span>|</span>
            <span id="currentDate"></span>
        </div>
    </div>
    
    <div class="tabs">
        <button class="tab active" onclick="switchTab('overview')">ðŸ“Š Overview</button>
        <button class="tab" onclick="switchTab('breakdown')">ðŸ“¦ Outbound Breakdown</button>
    </div>
    
    <div class="filters">
        <div class="filter-group">
            <label>Customer</label>
            <select id="customerFilter">
                <option value="all">All Customers</option>
            </select>
        </div>
        <div class="filter-group">
            <label>Date Range</label>
            <select id="dateRangeType" onchange="toggleCustomDates()">
                <option value="preset">Preset Range</option>
                <option value="custom">Custom Range</option>
            </select>
        </div>
        <div class="filter-group" id="presetDaysFilter">
            <label>Days Back</label>
            <select id="daysFilter">
                <option value="7">Last 7 Days</option>
                <option value="14">Last 14 Days</option>
                <option value="30" selected>Last 30 Days</option>
                <option value="60">Last 60 Days</option>
                <option value="90">Last 90 Days</option>
            </select>
        </div>
        <div class="filter-group" id="customStartDate" style="display:none;">
            <label>Start Date</label>
            <input type="date" id="startDate">
        </div>
        <div class="filter-group" id="customEndDate" style="display:none;">
            <label>End Date</label>
            <input type="date" id="endDate">
        </div>
        <button class="btn-apply" onclick="loadData()">Apply Filters</button>
    </div>
    
    <div class="container">
        <div id="tab-overview" class="tab-content active content">
            <div id="kpiSection" class="loading">
                <div class="spinner"></div>
                <div>Loading dashboard data...</div>
            </div>
            <div class="chart-grid" id="chartSection" style="display:none;">
                <div class="chart-card">
                    <div class="chart-title">Daily Orders</div>
                    <canvas id="dailyChart"></canvas>
                </div>
                <div class="chart-card">
                    <div class="chart-title">Monthly Orders</div>
                    <canvas id="monthlyChart"></canvas>
                </div>
            </div>
        </div>
        
        <div id="tab-breakdown" class="tab-content content">
            <div class="table-container">
                <div class="table-header">Customer SLA Performance</div>
                <div id="breakdownTable" class="loading">
                    <div class="spinner"></div>
                    <div>Loading order data...</div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const API_BASE = 'https://deliverzen-ops-backend.azurewebsites.net/api';
        let currentTab = 'overview';
        let dailyChartInstance, monthlyChartInstance;
        let customers = [];
        let sortColumn = null;
        let sortDirection = 'asc';
        
        document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        
        const today = new Date();
        const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
        document.getElementById('startDate').value = thirtyDaysAgo.toISOString().split('T')[0];
        document.getElementById('endDate').value = today.toISOString().split('T')[0];
        
        loadCustomers();
        loadData();
        setInterval(loadData, 900000);
        
        function toggleCustomDates() {
            const type = document.getElementById('dateRangeType').value;
            document.getElementById('presetDaysFilter').style.display = type === 'preset' ? 'flex' : 'none';
            document.getElementById('customStartDate').style.display = type === 'custom' ? 'flex' : 'none';
            document.getElementById('customEndDate').style.display = type === 'custom' ? 'flex' : 'none';
        }
        
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector(`button[onclick="switchTab('${tab}')"]`).classList.add('active');
            document.getElementById(`tab-${tab}`).classList.add('active');
            loadData();
        }
        
        async function loadCustomers() {
            try {
                const response = await fetch(`${API_BASE}/customers`);
                const data = await response.json();
                
                if (data.success) {
                    const select = document.getElementById('customerFilter');
                    select.innerHTML = '<option value="all">All Customers</option>';
                    data.data.forEach(c => {
                        const option = document.createElement('option');
                        option.value = c.ACCOUNT_ID;
                        option.textContent = c.CUSTOMER_NAME;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading customers:', error);
            }
        }
        
        async function loadData() {
            if (currentTab === 'overview') {
                await loadOverview();
                await loadCharts();
            } else if (currentTab === 'breakdown') {
                await loadBreakdown();
            }
        }
        
        function getDateParams() {
            const customer = document.getElementById('customerFilter').value;
            const dateType = document.getElementById('dateRangeType').value;
            let params = customer !== 'all' ? `customer_id=${customer}` : '';
            
            if (dateType === 'preset') {
                const days = document.getElementById('daysFilter').value;
                params += (params ? '&' : '') + `days=${days}`;
            } else {
                const start = document.getElementById('startDate').value;
                const end = document.getElementById('endDate').value;
                if (start && end) {
                    const daysDiff = Math.ceil((new Date(end) - new Date(start)) / (1000 * 60 * 60 * 24));
                    params += (params ? '&' : '') + `days=${daysDiff}`;
                }
            }
            
            return params;
        }
        
        async function loadOverview() {
            const params = getDateParams();
            
            document.getElementById('kpiSection').innerHTML = '<div class="loading"><div class="spinner"></div><div>Loading...</div></div>';
            
            try {
                const [summaryResp, dailyResp] = await Promise.all([
                    fetch(`${API_BASE}/executive-summary?${params}`),
                    fetch(`${API_BASE}/orders-by-day?${params}`)
                ]);
                
                const summaryData = await summaryResp.json();
                const dailyData = await dailyResp.json();
                
                if (!summaryData.success) throw new Error(summaryData.error);
                
                const kpisArray = summaryData.data;
                const metadata = summaryData.metadata;
                
                const d2cOtf = kpisArray.find(k => k.metric === 'D2C_OTF');
                const b2bOtf = kpisArray.find(k => k.metric === 'B2B_OTF');
                
                const d2cOtfPct = d2cOtf ? d2cOtf.value * 100 : null;
                const b2bOtfPct = b2bOtf ? b2bOtf.value * 100 : null;
                
                let d2cTotal = 0;
                let b2bTotal = 0;
                if (dailyData.success && dailyData.data) {
                    dailyData.data.forEach(day => {
                        d2cTotal += day.D2C_ORDERS || 0;
                        b2bTotal += day.B2B_ORDERS || 0;
                    });
                }
                
                const totalOrders = metadata?.total_orders || (d2cTotal + b2bTotal);
                
                document.getElementById('kpiSection').innerHTML = `
                    <div class="kpi-grid">
                        ${createKPI('D2C OTF %', d2cOtfPct !== null ? d2cOtfPct.toFixed(1) + '%' : 'N/A', d2cOtfPct >= 95 ? '#0EA55B' : d2cOtfPct >= 90 ? '#D97B06' : '#DC2C2C')}
                        ${createKPI('B2B OTF %', b2bOtfPct !== null ? b2bOtfPct.toFixed(1) + '%' : 'N/A', b2bOtfPct >= 92 ? '#0EA55B' : b2bOtfPct >= 85 ? '#D97B06' : '#DC2C2C')}
                        ${createKPI('Total Orders', totalOrders.toLocaleString(), '#2B6CF4')}
                        ${createKPI('D2C Orders', d2cTotal.toLocaleString(), '#7C3AED')}
                        ${createKPI('B2B Orders', b2bTotal.toLocaleString(), '#0891B2')}
                    </div>
                `;
            } catch (error) {
                document.getElementById('kpiSection').innerHTML = `
                    <div style="color: #DC2C2C; text-align: center; padding: 40px;">
                        <div style="font-weight: 700; margin-bottom: 8px;">Error Loading Data</div>
                        <div style="font-size: 13px;">${error.message}</div>
                    </div>
                `;
            }
        }
        
        async function loadCharts() {
            const params = getDateParams();
            
            try {
                const [dailyResp, monthlyResp] = await Promise.all([
                    fetch(`${API_BASE}/orders-by-day?${params}`),
                    fetch(`${API_BASE}/orders-by-month?months=6${params.includes('customer_id') ? '&' + params.split('&').find(p => p.startsWith('customer_id')) : ''}`)
                ]);
                
                const dailyData = await dailyResp.json();
                const monthlyData = await monthlyResp.json();
                
                if (dailyData.success && monthlyData.success) {
                    document.getElementById('chartSection').style.display = 'grid';
                    
                    if (dailyChartInstance) dailyChartInstance.destroy();
                    if (monthlyChartInstance) monthlyChartInstance.destroy();
                    
                    const formattedLabels = dailyData.data.map(d => {
                        const date = new Date(d.ORDER_DATE);
                        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    });
                    
                    dailyChartInstance = new Chart(document.getElementById('dailyChart'), {
                        type: 'line',
                        data: {
                            labels: formattedLabels,
                            datasets: [{
                                label: 'Total Orders',
                                data: dailyData.data.map(d => d.TOTAL_ORDERS),
                                borderColor: '#2B6CF4',
                                backgroundColor: 'rgba(43,108,244,0.1)',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: { 
                            responsive: true, 
                            maintainAspectRatio: true,
                            plugins: { legend: { display: true } },
                            scales: { x: { ticks: { maxRotation: 45, minRotation: 45 } } }
                        }
                    });
                    
                    monthlyChartInstance = new Chart(document.getElementById('monthlyChart'), {
                        type: 'bar',
                        data: {
                            labels: monthlyData.data.map(d => d.ORDER_MONTH),
                            datasets: [
                                { label: 'D2C', data: monthlyData.data.map(d => d.D2C_ORDERS), backgroundColor: '#7C3AED' },
                                { label: 'B2B', data: monthlyData.data.map(d => d.B2B_ORDERS), backgroundColor: '#0891B2' }
                            ]
                        },
                        options: { 
                            responsive: true, 
                            maintainAspectRatio: true, 
                            scales: { x: { stacked: true }, y: { stacked: true } } 
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading charts:', error);
            }
        }
        
        async function loadBreakdown() {
            const params = getDateParams();
            
            document.getElementById('breakdownTable').innerHTML = '<div class="loading"><div class="spinner"></div><div>Loading...</div></div>';
            
            try {
                const url = `${API_BASE}/customer-breakdown-summary?${params}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (!data.success) throw new Error(data.error);
                
                customers = data.data || [];
                
                if (customers.length === 0) {
                    document.getElementById('breakdownTable').innerHTML = '<div style="text-align:center; color:#8494AC; padding:40px;">No orders found</div>';
                    return;
                }
                
                renderBreakdownTable();
            } catch (error) {
                document.getElementById('breakdownTable').innerHTML = `
                    <div style="color: #DC2C2C; text-align: center; padding: 40px;">
                        <div style="font-weight: 700; margin-bottom: 8px;">Error Loading Breakdown</div>
                        <div style="font-size: 13px;">${error.message}</div>
                    </div>
                `;
            }
        }
        
        function renderBreakdownTable() {
            let customerList = [...customers];
            
            if (sortColumn !== null) {
                customerList.sort((a, b) => {
                    let aVal = sortColumn === 'name' ? a.CUSTOMER_NAME :
                               sortColumn === 'total' ? a.TOTAL_ORDERS :
                               sortColumn === 'passed' ? a.PASSED_ORDERS :
                               sortColumn === 'failed' ? a.FAILED_ORDERS :
                               a.SLA_PERCENT;
                    let bVal = sortColumn === 'name' ? b.CUSTOMER_NAME :
                               sortColumn === 'total' ? b.TOTAL_ORDERS :
                               sortColumn === 'passed' ? b.PASSED_ORDERS :
                               sortColumn === 'failed' ? b.FAILED_ORDERS :
                               b.SLA_PERCENT;
                    
                    if (typeof aVal === 'string') { aVal = aVal.toLowerCase(); bVal = bVal.toLowerCase(); }
                    return sortDirection === 'asc' ? (aVal > bVal ? 1 : -1) : (aVal < bVal ? 1 : -1);
                });
            }
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th onclick="sortTable('name')" class="${sortColumn === 'name' ? 'sort-' + sortDirection : ''}">Customer Name</th>
                            <th onclick="sortTable('total')" class="${sortColumn === 'total' ? 'sort-' + sortDirection : ''}">Order Received</th>
                            <th onclick="sortTable('passed')" class="${sortColumn === 'passed' ? 'sort-' + sortDirection : ''}">Completed Orders</th>
                            <th onclick="sortTable('failed')" class="${sortColumn === 'failed' ? 'sort-' + sortDirection : ''}">Failed Orders</th>
                            <th onclick="sortTable('sla')" class="${sortColumn === 'sla' ? 'sort-' + sortDirection : ''}">Average SLA (%)</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            customerList.forEach(cust => {
                html += `
                    <tr>
                        <td><strong>${cust.CUSTOMER_NAME}</strong></td>
                        <td>${cust.TOTAL_ORDERS.toLocaleString()}</td>
                        <td><span class="status-badge status-passed">${cust.PASSED_ORDERS.toLocaleString()}</span></td>
                        <td><span class="status-badge status-failed">${cust.FAILED_ORDERS.toLocaleString()}</span></td>
                        <td>${cust.SLA_PERCENT}%</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            document.getElementById('breakdownTable').innerHTML = html;
        }
        
        function sortTable(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }
            renderBreakdownTable();
        }
        
        function createKPI(label, value, color) {
            return `
                <div class="kpi-card" style="--color: ${color}">
                    <div class="kpi-label">${label}</div>
                    <div class="kpi-value" style="color: ${color}">${value || 'N/A'}</div>
                </div>
            `;
        }
    </script>
</body>
</html>